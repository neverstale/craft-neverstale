{% extends "_layouts/cp" %}
{% do view.registerAssetBundle('neverstale\\neverstale\\assets\\NeverstaleAsset') %}

{% set title = content.uiLabel %}
{% set docTitle = title %}
{% set selectedSubnavItem = 'content' %}

{% set crumbs = [
    { label: "Neverstale"|t('neverstale'), url: url('neverstale') },
    { label: "Content"|t('neverstale'), url: url('neverstale/content') },
    { label: content.uiLabel }
] %}

{# Add all action buttons to the header actions #}
{% block actionButton %}
    <div class="btngroup">
        <button type="button" class="btn submit" data-action="neverstale/content/ingest"
                data-content-id="{{ content.id }}">
            {{ "Trigger Analysis"|t('neverstale') }}
        </button>
        {% if content.entry %}
            <a href="{{ content.entry.cpEditUrl }}" class="btn" target="_blank">
                {{ "Edit Entry"|t('neverstale') }}
            </a>
        {% endif %}
        <a href="{{ url('neverstale/content') }}" class="btn">
            {{ "Back to Content"|t('neverstale') }}
        </a>
    </div>
{% endblock %}

{% block content %}
    <div class="content-body">
        <div class="grid" data-cols="2" style="align-items: stretch;">
            {# Left column - Content Flags (2/3 width) #}
            <div style="display: flex;">
                <div class="field" style="display: flex; flex-direction: column; flex: 1;">
                    {% set allFlags = content.getFlags() %}

                    {% if allFlags|length > 0 %}

                        {% if allFlags|length %}
                            <div class="heading">
                                <label>{{ "Content Flags"|t('neverstale') }}</label>
                            </div>
                            <div class="instructions">
                                <p>{{ "This content has {count} flag(s) detected by Neverstale analysis."|t('neverstale', { count: allFlags|length }) }}</p>
                            </div>

                            <div class="flag-cards">
                                {% for flag in allFlags %}
                                    <div class="flag-card{{ flag.isActive() ? '' : ' flag-ignored' }}">
                                        <div class="flag-header">
                                            <div class="flag-title">
                                                <span class="status {{ flag.isActive() ? 'red' : 'gray' }}"></span>
                                                <h6>{{ flag.flag|title }}{{ flag.isActive() ? '' : ' (Ignored)' }}</h6>
                                            </div>
                                        </div>

                                        {% if flag.reason %}
                                            <div class="flag-content">
                                                <p>{{ flag.reason }}</p>
                                            </div>
                                        {% endif %}

                                        {% if flag.snippet %}
                                            <div class="flag-snippet">
                                                <code class="language-text">{{ flag.snippet }}</code>
                                            </div>
                                        {% endif %}


                                        {% if flag.lastAnalyzedAt or flag.expiredAt %}
                                            <div class="flag-meta">
                                                {% if flag.lastAnalyzedAt %}
                                                    <span class="flag-meta-item">
                                                        <span class="light">{{ "Analyzed"|t('neverstale') }}</span>
                                                        {{ flag.lastAnalyzedAt|datetime('short') }}
                                                    </span>
                                                {% endif %}
                                                {% if flag.expiredAt %}
                                                    <span class="flag-meta-item">
                                                        <span class="light">{{ "Expires"|t('neverstale') }}</span>
                                                        {{ flag.expiredAt|date('M j, Y') }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="heading">
                            <label>{{ "Content Flags"|t('neverstale') }}</label>
                        </div>
                        <div style="text-align: center; padding: 60px 40px; background: #f9fafb; border-radius: 4px; border: 1px solid #e5e7eb; flex: 1; display: flex; flex-direction: column; justify-content: center;">
                            <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin: 0 auto 16px;">
                                <circle cx="24" cy="24" r="22" fill="#10b981" stroke="#059669" stroke-width="2"/>
                                <path d="M14 24L20 30L34 16" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p style="margin: 0; font-size: 16px; font-weight: 500; color: #374151;">{{ "All clear! No flags detected for this content."|t('neverstale') }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            {# Right column - Content Details (1/3 width) #}
            <div style="display: flex;">
                <div class="field" style="flex: 1;">
                    <div class="heading">
                        <label>{{ "Content Details"|t('neverstale') }}</label>
                    </div>
                    <div class="instructions">
                        <p>{{ "Metadata and analysis information for this content."|t('neverstale') }}</p>
                    </div>

                    <div class="meta readable">
                        <div class="data">
                            <h5 class="heading">{{ "Status"|t('app') }}</h5>
                            <div class="value">
                                {% if content.statusColor is defined and content.statusModel is defined %}
                                    <span class="status {{ content.statusColor }}"
                                          style="white-space: nowrap; display: inline-block;"></span>
                                    <span>{{ content.statusModel.label ?? content.status ?? 'Unknown' }}</span>
                                {% else %}
                                    <span class="status gray"
                                          style="white-space: nowrap; display: inline-block;"></span>
                                    <span>{{ content.status ?? 'Unknown' }}</span>
                                {% endif %}
                            </div>
                        </div>

                        {% if content.flagCount is not null %}
                            <div class="data">
                                <h5 class="heading">{{ "Flag Count"|t('neverstale') }}</h5>
                                <div class="value">{{ content.flagCount }}</div>
                            </div>
                        {% endif %}

                        {% if content.dateAnalyzed %}
                            <div class="data">
                                <h5 class="heading">{{ "Date Analyzed"|t('neverstale') }}</h5>
                                <div class="value">{{ content.dateAnalyzed|datetime }}</div>
                            </div>
                        {% endif %}

                        {% if content.dateExpired %}
                            <div class="data">
                                <h5 class="heading">{{ "Date Expired"|t('neverstale') }}</h5>
                                <div class="value">{{ content.dateExpired|datetime }}</div>
                            </div>
                        {% endif %}

                        {% if content.neverstaleId %}
                            <div class="data">
                                <h5 class="heading">{{ "Neverstale ID"|t('neverstale') }}</h5>
                                <div class="value"><code>{{ content.neverstaleId }}</code></div>
                            </div>
                        {% endif %}

                        <div class="data">
                            <h5 class="heading">{{ "Custom ID"|t('neverstale') }}</h5>
                            <div class="value">
                                {% if content.customId is defined %}
                                    <code>{{ content.customId }}</code>
                                {% else %}
                                    <code>{{ content.entryId ~ ':' ~ content.siteId ~ ':' ~ content.id }}</code>
                                {% endif %}
                            </div>
                        </div>

                        <div class="data">
                            <h5 class="heading">{{ "Site"|t('app') }}</h5>
                            <div class="value">{{ content.site.name ?? "Unknown"|t('neverstale') }}</div>
                        </div>

                        <div class="data">
                            <h5 class="heading">{{ "Date Created"|t('app') }}</h5>
                            <div class="value">{{ content.dateCreated|datetime }}</div>
                        </div>

                        <div class="data">
                            <h5 class="heading">{{ "Date Updated"|t('app') }}</h5>
                            <div class="value">{{ content.dateUpdated|datetime }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Transaction logs #}
        {% if transactionLogs is defined and transactionLogs|length %}
            <div class="field">
                <div class="heading">
                    <label>{{ "Transaction History"|t('neverstale') }}</label>
                </div>
                <div class="instructions">
                    <p>{{ "History of API interactions and status changes for this content."|t('neverstale') }}</p>
                </div>

                <div class="tablechart">
                    <table class="data fullwidth">
                        <thead>
                            <tr>
                                <th>{{ "Date"|t('app') }}</th>
                                <th>{{ "Event"|t('neverstale') }}</th>
                                <th>{{ "Status"|t('app') }}</th>
                                <th>{{ "Message"|t('neverstale') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactionLogs %}
                                <tr>
                                    <td>{{ transaction.dateCreated|datetime }}</td>
                                    <td>{{ transaction.event ?: "—" }}</td>
                                    <td>{{ transaction.status ?: "—" }}</td>
                                    <td>{{ transaction.message ?: "—" }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% js %}
    // Handle trigger analysis button
    document.addEventListener('DOMContentLoaded', function() {
    const triggerBtn = document.querySelector('[data-action="neverstale/content/ingest"]');

    if (triggerBtn) {
    triggerBtn.addEventListener('click', function() {
    const contentId = this.getAttribute('data-content-id');
    const originalText = this.textContent;

    // Disable button and show loading state
    this.disabled = true;
    this.textContent = 'Triggering Analysis...';
    this.classList.add('loading');

    // Make the API request
    Craft.sendActionRequest('POST', 'neverstale/content/ingest', {
    data: {
    contentId: contentId
    }
    }).then((response) => {
    if (response.data.success) {
    Craft.cp.displayNotice(response.data.message || 'Analysis triggered successfully');
    // Reload the page after a short delay to show updated data
    setTimeout(() => {
    window.location.reload();
    }, 1500);
    } else {
    Craft.cp.displayError(response.data.error || 'Failed to trigger analysis');
    // Re-enable button
    this.disabled = false;
    this.textContent = originalText;
    this.classList.remove('loading');
    }
    }).catch((error) => {
    console.error('Error triggering analysis:', error);
    Craft.cp.displayError('Failed to trigger analysis');
    // Re-enable button
    this.disabled = false;
    this.textContent = originalText;
    this.classList.remove('loading');
    });
    });
    }
    });
{% endjs %}
